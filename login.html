<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login | Centre for Peace Praxis</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- Modern Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom Glass Styles -->
    <link rel="stylesheet" href="login.css">
</head>

<body>

    <div class="login-container">
        <div class="login-card">

            <!-- Camera/Tech Badge Icon -->
            <div class="icon-badge">
                <i class="fas fa-camera"></i>
            </div>

            <div class="login-header">
                <h2>ADMIN ACCESS</h2>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <input type="email" id="username" class="form-control" placeholder="Email Address" required
                        autocomplete="off">
                    <i class="fas fa-user input-icon"></i>
                </div>

                <div class="form-group">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                    <i class="fas fa-lock input-icon"></i>
                    <i class="fas fa-eye password-toggle" id="togglePassword"></i>
                </div>

                <div class="form-actions" style="justify-content: flex-end;">
                    <a href="#" class="forgot-link">Forgot Password?</a>
                </div>

                <div id="errorMsg" class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> Invalid Credentials
                </div>

                <button type="submit" class="btn-login">
                    Login
                </button>
            </form>

            <div style="margin-top: 30px;">
                <a href="index.html"
                    style="color: rgba(255,255,255,0.4); text-decoration: none; font-size: 0.8rem; letter-spacing: 1px;">
                    <i class="fas fa-arrow-left"></i> BACK TO SITE
                </a>
            </div>
        </div>
    </div>

    <!-- Auth Logic -->
    <!-- Auth Logic -->
    <script type="module">
        import { Auth } from './auth.js';

        // Wait for DOM
        document.addEventListener('DOMContentLoaded', () => {
            // Check session - Async monitor
            // If user is already logged in, redirect
            Auth.monitor((user) => {
                if (user) {
                    window.location.replace('dashboard.html');
                }
            });

            const loginForm = document.getElementById('loginForm');
            const usernameInput = document.getElementById('username'); // Acts as email
            const passwordInput = document.getElementById('password');
            const errorMsg = document.getElementById('errorMsg');
            const btn = document.querySelector('.btn-login');

            // Slight delay animation for inputs
            setTimeout(() => {
                usernameInput.focus();
            }, 500);

            loginForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                let email = usernameInput.value.trim();
                const password = passwordInput.value.trim();

                // Usability Fix: If user entered "bds@2025" (no TLD), append .com
                // Firebase requires a valid domain.
                if (email.includes('@') && !email.includes('.')) {
                    email += '.com';
                }

                // Loading State
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ACCESSING...';
                btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                errorMsg.style.display = 'none';

                try {
                    await Auth.login(email, password);
                    // Success! Auth monitor above will handle redirect
                    // But we can double check or just wait
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 500);

                } catch (error) {
                    // Reset Button
                    btn.innerHTML = 'Login';
                    btn.style.background = ''; // reset to css default

                    // Show Error
                    errorMsg.style.display = 'block';
                    errorMsg.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${mapFirebaseError(error.code)}`;

                    // Reset Logic
                    passwordInput.value = '';
                    passwordInput.focus();

                    // Error Shake
                    const card = document.querySelector('.login-card');
                    card.classList.remove('shake-anim');
                    void card.offsetWidth;
                    card.classList.add('shake-anim');
                }
            });

            // Input handlers
            [usernameInput, passwordInput].forEach(input => {
                input.addEventListener('input', () => {
                    errorMsg.style.display = 'none';
                });
            });

            // Password Toggle Logic
            const togglePassword = document.getElementById('togglePassword');
            if (togglePassword) {
                togglePassword.addEventListener('click', function () {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    this.classList.toggle('fa-eye');
                    this.classList.toggle('fa-eye-slash');
                });
            }

            // Helper: User-Friendly Errors
            function mapFirebaseError(code) {
                switch (code) {
                    case 'auth/invalid-email': return 'Invalid Email Address';
                    case 'auth/user-not-found': return 'User not found';
                    case 'auth/wrong-password': return 'Incorrect Password';
                    case 'auth/too-many-requests': return 'Too many attempts. Try later.';
                    default: return 'Authentication Failed';
                }
            }
        });
    </script>
</body>

</html>